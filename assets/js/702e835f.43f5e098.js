"use strict";(self.webpackChunkbuildbuddy_docs_website=self.webpackChunkbuildbuddy_docs_website||[]).push([[4012],{3905:function(e,t,a){a.d(t,{Zo:function(){return m},kt:function(){return u}});var n=a(67294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},m=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},p=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,m=l(e,["components","mdxType","originalType","parentName"]),d=c(a),p=o,u=d["".concat(s,".").concat(p)]||d[p]||h[p]||i;return a?n.createElement(u,r(r({ref:t},m),{},{components:a})):n.createElement(u,r({ref:t},m))}));function u(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,r=new Array(i);r[0]=p;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:o,r[1]=l;for(var c=2;c<i;c++)r[c]=a[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}p.displayName="MDXCreateElement"},85414:function(e,t,a){a.r(t),a.d(t,{assets:function(){return m},contentTitle:function(){return s},default:function(){return u},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return d}});var n=a(83117),o=a(80102),i=(a(67294),a(3905)),r=["components"],l={slug:"bazels-remote-caching-and-remote-execution-explained",title:"Bazel's Remote Caching and Remote Execution Explained",description:"A nuts and bolts (or rather actions and spawns \ud83d\ude04) overview of Bazel's remote caching and remote execution capabilities.",author:"Brentley Jones",author_title:"Developer Evangelist @ BuildBuddy",date:"2022-03-16:12:00:00",author_url:"https://brentleyjones.com",author_image_url:"https://avatars.githubusercontent.com/u/158658?v=4",image:"/img/bazel_remote_explained.png",tags:["bazel"]},s=void 0,c={permalink:"/blog/bazels-remote-caching-and-remote-execution-explained",editUrl:"https://github.com/buildbuddy-io/buildbuddy/edit/master/website/blog/bazels-remote-caching-and-remote-execution-explained.md",source:"@site/blog/bazels-remote-caching-and-remote-execution-explained.md",title:"Bazel's Remote Caching and Remote Execution Explained",description:"A nuts and bolts (or rather actions and spawns \ud83d\ude04) overview of Bazel's remote caching and remote execution capabilities.",date:"2022-03-16T12:00:00.000Z",formattedDate:"March 16, 2022",tags:[{label:"bazel",permalink:"/blog/tags/bazel"}],readingTime:12.23,hasTruncateMarker:!0,authors:[{name:"Brentley Jones",title:"Developer Evangelist @ BuildBuddy",url:"https://brentleyjones.com",imageURL:"https://avatars.githubusercontent.com/u/158658?v=4"}],frontMatter:{slug:"bazels-remote-caching-and-remote-execution-explained",title:"Bazel's Remote Caching and Remote Execution Explained",description:"A nuts and bolts (or rather actions and spawns \ud83d\ude04) overview of Bazel's remote caching and remote execution capabilities.",author:"Brentley Jones",author_title:"Developer Evangelist @ BuildBuddy",date:"2022-03-16:12:00:00",author_url:"https://brentleyjones.com",author_image_url:"https://avatars.githubusercontent.com/u/158658?v=4",image:"/img/bazel_remote_explained.png",tags:["bazel"]},prevItem:{title:"Meet rules_xcodeproj",permalink:"/blog/meet-rules_xcodeproj"},nextItem:{title:"How Bazel 5.0 Makes Your Builds Faster",permalink:"/blog/how-bazel-5-0-makes-your-builds-faster"}},m={authorsImageUrls:[void 0]},d=[{value:"Actions",id:"actions",level:2},{value:"Spawns",id:"spawns",level:2},{value:"Parallelism",id:"parallelism",level:3},{value:"Remote caching",id:"remote-caching",level:2},{value:"<code>remote-cache</code>",id:"remote-cache",level:3},{value:"Flags",id:"flags",level:3},{value:"Remote execution",id:"remote-execution",level:2},{value:"<code>remote</code>",id:"remote",level:3},{value:"Disk cache",id:"disk-cache",level:3},{value:"Dynamic execution",id:"dynamic-execution",level:3},{value:"Flags",id:"flags-1",level:3},{value:"Remote Build without the Bytes",id:"remote-build-without-the-bytes",level:2},{value:"Bonus topic: Build Event Service",id:"bonus-topic-build-event-service",level:2},{value:"Flags",id:"flags-2",level:3},{value:"That&#39;s it, for now",id:"thats-it-for-now",level:2}],h={toc:d},p="wrapper";function u(e){var t=e.components,l=(0,o.Z)(e,r);return(0,i.kt)(p,(0,n.Z)({},h,l,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Bazel's famous remote caching and remote execution capabilities can be a game changer,\nbut if you're not familiar with how they work,\nthey can be a bit of a mystery."),(0,i.kt)("p",null,"Well, don't worry.\nI'm here with to go over the fundamentals of remote caching and remote execution,\nwith a nuts and bolts\n(or rather actions and spawns \ud83d\ude04)\noverview of Bazel's remote capabilities."),(0,i.kt)("h2",{id:"actions"},"Actions"),(0,i.kt)("p",null,"Each ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#rule"},"rule target")," in the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#build-graph"},"build graph")," of a requested build produces zero or more ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#action"},"actions")," during the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#analysis-phase"},"analysis phase"),".\nThese actions form an ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#action-graph"},"action graph"),",\nrepresenting all the actions that need to be performed during the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#execution-phase"},"execution phase"),"."),(0,i.kt)("p",null,(0,i.kt)("img",{src:a(58553).Z,width:"672",height:"528"})),(0,i.kt)("p",null,"During the execution phase the action graph is traversed.\nFor each action,\nBazel determines if it has to be executed,\neither because the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/bazel/blob/5.0.0/src/main/java/com/google/devtools/build/lib/actions/ActionResult.java#L26-L28"},"action result")," doesn't exist in the output base's ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#action-cache"},"action cache"),",\nor because the output in the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/glossary.html#output-base"},"output base")," doesn't match the output listed in the action result."),(0,i.kt)("h2",{id:"spawns"},"Spawns"),(0,i.kt)("p",null,"If Bazel has to execute an action,\nit creates a ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/bazel/blob/5.0.0/src/main/java/com/google/devtools/build/lib/actions/Spawn.java#L25-L30"},"spawn"),",\nwhich encodes all the information needed to be able to execute the action,\nincluding the spawn's ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/bazel/blob/5.0.0/src/main/java/com/google/devtools/build/lib/actions/SpawnStrategy.java#L18-L28"},'"strategy"'),(0,i.kt)("sup",{parentName:"p",id:"fnref-1-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-1-7879ad",className:"footnote-ref"},"1")),",\nwhich,\namong other things,\ndetermines if/how the spawn should utilize remote caching or remote execution."),(0,i.kt)("p",null,"A spawn's strategy will dictate if Bazel has to do additional work\nbefore,\nafter,\nor instead of executing an action locally.\nFor example,\nif a spawn with the ",(0,i.kt)("inlineCode",{parentName:"p"},"remote-cache")," strategy is executed,\nBazel may check if the action result exists in the external cache's action cache,\nand if it does,\nit might download the listed outputs instead of executing the action.\nI go over this in greater detail ",(0,i.kt)("a",{parentName:"p",href:"#remote-caching"},"later"),"."),(0,i.kt)("p",null,"After an action's outputs are available in the output base,\neither because they were downloaded or created locally,\ndependent actions in the action graph can spawn."),(0,i.kt)("h3",{id:"parallelism"},"Parallelism"),(0,i.kt)("a",{id:"local_cpu_resources-flag"}),(0,i.kt)("p",null,"The number of actions that can be executed locally at once is limited by the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--local_cpu_resources"},(0,i.kt)("inlineCode",{parentName:"a"},"--local_cpu_resources"))," flag.\nThe number of spawns that can be executed at once is limited by the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--jobs"},(0,i.kt)("inlineCode",{parentName:"a"},"--jobs"))," flag.\nSince a spawn's execution can include more work,\nor different work,\nthan an action's local execution,\nit can be beneficial to have a ",(0,i.kt)("inlineCode",{parentName:"p"},"--jobs")," value that is larger than ",(0,i.kt)("inlineCode",{parentName:"p"},"--local_cpu_resources"),".\nWhen that is the case,\nand a spawn tries to execute an action locally,\nit might block waiting for CPU resources to free up.\nThis is where ",(0,i.kt)("a",{parentName:"p",href:"#remote-execution"},"remote execution")," can be beneficial."),(0,i.kt)("h2",{id:"remote-caching"},"Remote caching"),(0,i.kt)("p",null,"To prevent confusion over Bazel's concept of a ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/remote-caching.html"},'"remote cache"'),",\nwhich can mean either a disk cache which is local to the machine,\nor a remote cache which uses networking protocols and is probably not local to the machine,\nI'm going to instead refer to both of these cache types as an \"external cache\",\nas it's external to the output base."),(0,i.kt)("p",null,"When using an external cache,\nBazel will augment it's output base with the action cache (AC) and content-addressable storage (CAS) of the external cache.\nThis means if an action result for an action that Bazel wants to execute isn't in the output base's action cache,\nBazel can check if the AC has it.\nThe same is true for the action's outputs;\nif the output base doesn't have the expected output,\nthen Bazel can check if the CAS has it."),(0,i.kt)("h3",{id:"remote-cache"},(0,i.kt)("inlineCode",{parentName:"h3"},"remote-cache")),(0,i.kt)("p",null,"Bazel achieves this behavior with the ",(0,i.kt)("inlineCode",{parentName:"p"},"remote-cache")," spawn strategy,\nwhich is used alongside a local strategy (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"sandbox"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"worker"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"local"),", etc.)."),(0,i.kt)("p",null,"A ",(0,i.kt)("inlineCode",{parentName:"p"},"remote-cache")," spawn has the following steps:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If the action's action result isn't in the output base's action cache,\ntry to retrieve it from the AC\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/remote-apis/blob/3e816456ee28f01ab2e0abf72306c1f340c7b229/build/bazel/remote/execution/v2/remote_execution.proto#L145-L159"},(0,i.kt)("inlineCode",{parentName:"a"},"ActionCache.GetActionResult")),")",(0,i.kt)("sup",{parentName:"li",id:"fnref-2-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-2-7879ad",className:"footnote-ref"},"2"))),(0,i.kt)("li",{parentName:"ul"},"If the action result was retrieved from either cache...",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"And the action's outputs are in the output base,\nthe spawn is done"),(0,i.kt)("li",{parentName:"ul"},"Otherwise,\ntry to retrieve it from the CAS\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/googleapis/googleapis/blob/885183fcec1a9b3a812055c209fa61f391c9042c/google/bytestream/bytestream.proto#L50-L53"},(0,i.kt)("inlineCode",{parentName:"a"},"ByteStream.Read")),")"))),(0,i.kt)("li",{parentName:"ul"},"If the outputs were retrieved,\nthe spawn is done"),(0,i.kt)("li",{parentName:"ul"},"Otherwise,\nthe action is executed locally"),(0,i.kt)("li",{parentName:"ul"},"If the action completes successfully,\nthe action's outputs are uploaded to the CAS\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/googleapis/googleapis/blob/885183fcec1a9b3a812055c209fa61f391c9042c/google/bytestream/bytestream.proto#L55-L77"},(0,i.kt)("inlineCode",{parentName:"a"},"ByteStream.Write")),"),\nand its action result is uploaded to the AC\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/remote-apis/blob/3e816456ee28f01ab2e0abf72306c1f340c7b229/build/bazel/remote/execution/v2/remote_execution.proto#L161-L182"},(0,i.kt)("inlineCode",{parentName:"a"},"ActionCache.UpdateActionResult")),")",(0,i.kt)("sup",{parentName:"li",id:"fnref-3-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-3-7879ad",className:"footnote-ref"},"3")),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"If ",(0,i.kt)("a",{parentName:"li",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--experimental_remote_cache_async"},(0,i.kt)("inlineCode",{parentName:"a"},"--experimental_remote_cache_async")),(0,i.kt)("sup",{parentName:"li",id:"fnref-4-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-4-7879ad",className:"footnote-ref"},"4"))," is used,\nthen the spawn is done,\nand dependent actions are able to spawn\nwhile uploads continue in the background"),(0,i.kt)("li",{parentName:"ul"},"Otherwise,\nuploads have to finish before dependent actions are able to spawn")))),(0,i.kt)("h3",{id:"flags"},"Flags"),(0,i.kt)("a",{id:"disk_cache-flag"}),(0,i.kt)("a",{id:"remote_cache-flag"}),(0,i.kt)("p",null,"Setting the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--disk_cache"},(0,i.kt)("inlineCode",{parentName:"a"},"--disk_cache"))," flag causes Bazel to use that directory on the filesystem as an external cache.\nSetting the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_cache"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_cache")),' flag causes Bazel to connect via HTTP(S), gRPC(S), or UNIX sockets to an external cache.\nSetting both flags causes Bazel to use both the disk cache and the remote cache at the same time,\nforming a "combined cache".'),(0,i.kt)("p",null,"A combined cache reads from and writes to both the disk and remote caches,\nand is treated like a remote cache overall,\nunless the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--incompatible_remote_results_ignore_disk"},(0,i.kt)("inlineCode",{parentName:"a"},"--incompatible_remote_results_ignore_disk"))," flag is used.\nIf that flag is used,\nthe disk cache instead continues to behave like a local cache,\nallowing it to return results even if ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_accept_cached"},(0,i.kt)("inlineCode",{parentName:"a"},"--noremote_accept_cached"))," is set,\nstore results even if ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_upload_local_results"},(0,i.kt)("inlineCode",{parentName:"a"},"--noremote_upload_local_results"))," is set,\nand return/store results for ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/be/common-definitions.html#common.tags"},(0,i.kt)("inlineCode",{parentName:"a"},"no-remote-cache"),"/",(0,i.kt)("inlineCode",{parentName:"a"},"no-remote"))," actions.",(0,i.kt)("sup",{parentName:"p",id:"fnref-5-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-5-7879ad",className:"footnote-ref"},"5"))),(0,i.kt)("a",{id:"experimental_guard_against_concurrent_changes-flag"}),(0,i.kt)("p",null,"Setting the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--experimental_guard_against_concurrent_changes"},(0,i.kt)("inlineCode",{parentName:"a"},"--experimental_guard_against_concurrent_changes"))," flag helps protect the external cache from being poisoned by changes to input files that happen during a build.\nI highly recommend setting this flag if developers have an external cache enabled,\neven if it's only the disk cache."),(0,i.kt)("a",{id:"remote_instance_name-flag"}),(0,i.kt)("p",null,"Most remote cache implementations will separate the AC,\nand some will separate the CAS,\nbased on the value of the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_instance_name"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_instance_name"))," flag.\nThis can used for numerous reasons,\nsuch as project separation,\nor a bandage for non-hermetic toolchains."),(0,i.kt)("a",{id:"remote_cache_header-flag"}),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_cache_header"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_cache_header"))," flag causes Bazel to send extra headers in requests to the external cache.\nMultiple headers can be passed by specifying the flag multiple times.\nMultiple values for the same name will be converted to a comma-separated list.\nThe ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_header"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_header"))," flag can be used instead of setting both ",(0,i.kt)("inlineCode",{parentName:"p"},"--remote_cache_header")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"--remote_exec_header")," to the same value."),(0,i.kt)("h2",{id:"remote-execution"},"Remote execution"),(0,i.kt)("p",null,"Bazel is able to execute actions on a remote executor,\ninstead of executing them locally,\nusing a concept called ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/remote-execution.html"},'"remote execution"'),".\nSince these actions don't use local resources,\nthe number of actions that can be executed remotely in parallel is limited only by ",(0,i.kt)("inlineCode",{parentName:"p"},"--jobs")," and the available remote resources,\nnot ",(0,i.kt)("inlineCode",{parentName:"p"},"--local_cpu_resources"),".\nIf your builds are sufficiently parallel,\nthis can result in them completing faster.\nThe ",(0,i.kt)("a",{parentName:"p",href:"#parallelism"},"parallelism section")," goes into more detail."),(0,i.kt)("h3",{id:"remote"},(0,i.kt)("inlineCode",{parentName:"h3"},"remote")),(0,i.kt)("p",null,"Bazel achieves the behavior of executing actions remotely with the ",(0,i.kt)("inlineCode",{parentName:"p"},"remote")," spawn strategy,\nwhich includes most of the behavior of the ",(0,i.kt)("a",{parentName:"p",href:"#remote-cache"},(0,i.kt)("inlineCode",{parentName:"a"},"remote-cache"))," strategy,\nand is used instead of a local strategy (e.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"sandbox"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"worker"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"local"),", etc.)."),(0,i.kt)("p",null,"A ",(0,i.kt)("inlineCode",{parentName:"p"},"remote")," spawn has the following steps:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If the action's action result isn't in the output base's action cache,\ntry to retrieve it from the AC\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/remote-apis/blob/3e816456ee28f01ab2e0abf72306c1f340c7b229/build/bazel/remote/execution/v2/remote_execution.proto#L145-L159"},(0,i.kt)("inlineCode",{parentName:"a"},"ActionCache.GetActionResult")),")",(0,i.kt)("sup",{parentName:"li",id:"fnref-6-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-6-7879ad",className:"footnote-ref"},"6"))),(0,i.kt)("li",{parentName:"ul"},"If the action result was retrieved from either cache...",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"And the action's outputs are in the output base,\nthe spawn is done"),(0,i.kt)("li",{parentName:"ul"},"Otherwise,\ntry to retrieve it from the CAS\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/googleapis/googleapis/blob/885183fcec1a9b3a812055c209fa61f391c9042c/google/bytestream/bytestream.proto#L50-L53"},(0,i.kt)("inlineCode",{parentName:"a"},"ByteStream.Read")),")"))),(0,i.kt)("li",{parentName:"ul"},"If the outputs were retrieved,\nthe spawn is done"),(0,i.kt)("li",{parentName:"ul"},"Otherwise,\ndetermine if any inputs to the action need to be uploaded\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/remote-apis/blob/3e816456ee28f01ab2e0abf72306c1f340c7b229/build/bazel/remote/execution/v2/remote_execution.proto#L318-L329"},(0,i.kt)("inlineCode",{parentName:"a"},"ContentAddressableStorage.FindMissingBlobs")),"),\nand upload them\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/googleapis/googleapis/blob/885183fcec1a9b3a812055c209fa61f391c9042c/google/bytestream/bytestream.proto#L55-L77"},(0,i.kt)("inlineCode",{parentName:"a"},"ByteStream.Write")),")"),(0,i.kt)("li",{parentName:"ul"},"Then execute the action remotely (",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/remote-apis/blob/3e816456ee28f01ab2e0abf72306c1f340c7b229/build/bazel/remote/execution/v2/remote_execution.proto#L45-L115"},(0,i.kt)("inlineCode",{parentName:"a"},"Execution.Execute")),")"),(0,i.kt)("li",{parentName:"ul"},"If the action completes successfully,\ndownload the action's outputs from the CAS\n(",(0,i.kt)("a",{parentName:"li",href:"https://github.com/googleapis/googleapis/blob/885183fcec1a9b3a812055c209fa61f391c9042c/google/bytestream/bytestream.proto#L50-L53"},(0,i.kt)("inlineCode",{parentName:"a"},"ByteStream.Read")),")")),(0,i.kt)("h3",{id:"disk-cache"},"Disk cache"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/bazel/commit/cf57d036c2e1b608ca902267fbbdfeb7ee5aa166"},"Starting in Bazel 5.0"),",\nthe disk cache\n(or more specifically,\nthe combined cache)\ncan be used with remote execution.\nPrior to Bazel 5.0,\nif you also wanted to cache things locally,\nyou would have to setup a remote cache proxy sidecar."),(0,i.kt)("h3",{id:"dynamic-execution"},"Dynamic execution"),(0,i.kt)("p",null,"Bazel supports a mode of remote execution called ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/dynamic-execution.html"},'"dynamic execution"'),",\nin which local and remote execution of the same action are started in parallel,\nusing the output from the first branch that finishes,\nand cancelling the other branch."),(0,i.kt)("p",null,"I wanted to mention it for completeness,\nbecause when tuned properly it can result in faster builds than using either local execution or remote execution alone.\nHowever,\nit might not play well with ",(0,i.kt)("a",{parentName:"p",href:"#remote-build-without-the-bytes"},"Remote Build without the Bytes"),",\nas the local execution branches might need to download the outputs of previous remotely completed actions,\nand if tuned improperly,\nit can result in slower builds."),(0,i.kt)("h3",{id:"flags-1"},"Flags"),(0,i.kt)("a",{id:"remote_executor-flag"}),(0,i.kt)("p",null,"Setting the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_executor"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_executor"))," flag causes Bazel to connect via gRPC(S) or UNIX sockets to a remote executor.\nIf ",(0,i.kt)("inlineCode",{parentName:"p"},"--remote_cache")," isn't set,\nit defaults to the value set for ",(0,i.kt)("inlineCode",{parentName:"p"},"--remote_executor"),".\nMost remote execution setups will have the remote cache and remote executor at the same endpoint."),(0,i.kt)("p",null,"In addition to how it ",(0,i.kt)("a",{parentName:"p",href:"#flags"},"affects the remote cache"),",\nthe ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_instance_name"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_instance_name"))," flag might determine which remote execution cluster a build runs on.\nSome actions might need to target a specific subset of executors,\npossibly because they need certain hardware or software,\nand they can do that with ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/platforms-intro.html#common-platform-properties"},"platform properties"),"."),(0,i.kt)("a",{id:"remote_default_exec_properties-flag"}),(0,i.kt)("p",null,"Platform properties can be set globally with the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_default_exec_properties"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_default_exec_properties"))," flag,\nbut only if they aren't set at the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/be/platform.html#platform.exec_properties"},"platform")," or ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/be/common-definitions.html#common.exec_properties"},"target")," level.\nThe action result that is stored in an action cache includes the platform properties.\nThis is important to note, as it can affect action cache hit rates.\nIf you conditionally use remote execution,\nand you use set platform properties,\nyou might want to have them set non-conditionally,\nin order to be able to reuse the cached action results.\nSome remote execution implementations allow setting global platform properties with ",(0,i.kt)("a",{parentName:"p",href:"#remote_exec_header-flag"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_exec_header"))," flags,\nas a way to prevent these cache misses."),(0,i.kt)("a",{id:"remote_timeout-flag"}),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_timeout"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_timeout"))," flag controls how long Bazel will wait for a remote cache operation to complete.\nWhile the timeout doesn't apply to the ",(0,i.kt)("inlineCode",{parentName:"p"},"Execution.Execute")," call",(0,i.kt)("sup",{parentName:"p",id:"fnref-7-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-7-7879ad",className:"footnote-ref"},"7")),",\nusing remote execution might involve uploading or downloading artifacts that a local build doesn't,\nand the default value for this flag\n(60 seconds)\nmight not be long enough."),(0,i.kt)("a",{id:"remote_retires-flag"}),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_retries"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_retries"))," flag controls how many times Bazel will retry a remote operation on a transient error,\nsuch as a timeout.\nThe flag defaults to ",(0,i.kt)("inlineCode",{parentName:"p"},"5"),",\nand depending on how you plan to use remote execution,\nyou might want to increase it to a much larger value.\nBazel uses an exponential backoff for retries,\nbut currently caps the delay at 5 seconds between calls."),(0,i.kt)("a",{id:"remote_exec_header-flag"}),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_exec_header"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_exec_header"))," flag causes Bazel to send extra headers in requests to the remote executor.\nMultiple headers can be passed by specifying the flag multiple times.\nMultiple values for the same name will be converted to a comma-separated list.\nThe ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_header"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_header"))," flag can be used instead of setting both ",(0,i.kt)("inlineCode",{parentName:"p"},"--remote_cache_header")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"--remote_exec_header")," to the same value."),(0,i.kt)("h2",{id:"remote-build-without-the-bytes"},"Remote Build without the Bytes"),(0,i.kt)("p",null,"For both remote caching and remote execution,\nBazel supports a feature called ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/bazel/issues/6862"},'"Remote Build without the Bytes"')," (BwtB).\nIf enabled,\nBazel will only download the direct outputs of the targets specified\n(",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_download_toplevel"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_download_toplevel")),"),\nor the minimum needed to complete the build\n(",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_download_minimal"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_download_minimal")),").\nThis can result in greatly reduced network traffic,\nwhich can also result in faster builds."),(0,i.kt)("p",null,"The feature isn't without its flaws though.\nCurrently,\nBwtB requires remote caches to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/bazel/issues/8250"},"never evict outputs"),",\ncan result in slower builds due to clumping of downloads,\ndoesn't allow specifying that other outputs should be downloaded,\netc.\nThough,\nsimilar to ",(0,i.kt)("a",{parentName:"p",href:"#dynamic-scheduling"},"dynamic scheduling"),",\nif used properly BwtB can result in faster builds.\nJust don't apply it blindly."),(0,i.kt)("h2",{id:"bonus-topic-build-event-service"},"Bonus topic: Build Event Service"),(0,i.kt)("p",null,"Bazel can stream build results,\nspecifically the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/build-event-protocol.html"},"build event protocol")," (BEP),\nto a ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/build-event-protocol.html#build-event-service"},"build event service")," (BES).\nDepending on the capabilities of the service,\nthis can have numerous benefits."),(0,i.kt)("p",null,"Here is a list of some benefits that various BES products (including BuildBuddy!) offer:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Easily share build logs"),(0,i.kt)("li",{parentName:"ul"},"See historical build data, including aggregations and trends"),(0,i.kt)("li",{parentName:"ul"},"See details not exposed via the terminal\n(e.g. all command-line flags used without having to use ",(0,i.kt)("a",{parentName:"li",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--announce_rc"},(0,i.kt)("inlineCode",{parentName:"a"},"--announce_rc")),",\nor all environment variables set)"),(0,i.kt)("li",{parentName:"ul"},"View action timing data (same as ",(0,i.kt)("a",{parentName:"li",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--experimental_generate_json_trace_profile"},(0,i.kt)("inlineCode",{parentName:"a"},"--experimental_generate_json_trace_profile")),")"),(0,i.kt)("li",{parentName:"ul"},"Visualize queries"),(0,i.kt)("li",{parentName:"ul"},"View error and test logs"),(0,i.kt)("li",{parentName:"ul"},"Download action outputs"),(0,i.kt)("li",{parentName:"ul"},"View remote cache stats"),(0,i.kt)("li",{parentName:"ul"},"View related remote execution data",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"List of actions executed"),(0,i.kt)("li",{parentName:"ul"},"Individual action details\n(e.g. command-line arguments,\nenvironment variables,\nplatform properties,\ntiming data,\nand downloading inputs and outputs)")))),(0,i.kt)("h3",{id:"flags-2"},"Flags"),(0,i.kt)("a",{id:"bes_backend-flag"}),(0,i.kt)("p",null,"Setting the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--bes_backend"},(0,i.kt)("inlineCode",{parentName:"a"},"--bes_backend"))," flag causes Bazel to connect via gRPC(S) to a BES backend and stream build results to it.\nSetting the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--bes_results_url"},(0,i.kt)("inlineCode",{parentName:"a"},"--bes_results_url"))," flag causes Bazel to output to the terminal a URL to the BES UI for the build underway."),(0,i.kt)("p",null,"When using BES,\nBazel will upload all files referenced in the BEP,\nunless ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--experimental_build_event_upload_strategy"},(0,i.kt)("inlineCode",{parentName:"a"},"--experimental_build_event_upload_strategy=local")),(0,i.kt)("sup",{parentName:"p",id:"fnref-8-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-8-7879ad",className:"footnote-ref"},"8"))," is set.\nAlternatively,\nif you set ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--incompatible_remote_build_event_upload_respect_no_cache"},(0,i.kt)("inlineCode",{parentName:"a"},"--incompatible_remote_build_event_upload_respect_no_cache")),(0,i.kt)("sup",{parentName:"p",id:"fnref-9-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-9-7879ad",className:"footnote-ref"},"9")),",\nand have actions that are tagged with ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/be/common-definitions.html#common.tags"},(0,i.kt)("inlineCode",{parentName:"a"},"no-cache"),"/",(0,i.kt)("inlineCode",{parentName:"a"},"no-remote-cache-upload"),"/",(0,i.kt)("inlineCode",{parentName:"a"},"no-remote-cache"),"/",(0,i.kt)("inlineCode",{parentName:"a"},"no-remote")),",\nthen the output of those actions will still be excluded from upload."),(0,i.kt)("a",{id:"bes_timeout-flag"}),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--bes_timeout"},(0,i.kt)("inlineCode",{parentName:"a"},"--bes_timeout"))," flag controls how long Bazel will wait to finish uploading to BES after the build and tests have finished.\nBy default there is no timeout,\nwhich might not be what you want.\nIf you leave the default,\nyou should consider changing the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/bazel/blob/5.0.0/src/main/java/com/google/devtools/build/lib/buildeventservice/BuildEventServiceOptions.java#L145-L154"},(0,i.kt)("inlineCode",{parentName:"a"},"--bes_upload_mode"))," flag,\nwhich controls if Bazel should block the build for BES uploads\n(the default),\nor if it should finish the uploads in the background."),(0,i.kt)("a",{id:"bes_header-flag"}),(0,i.kt)("p",null,"The ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--bes_header"},(0,i.kt)("inlineCode",{parentName:"a"},"--bes_header")),(0,i.kt)("sup",{parentName:"p",id:"fnref-10-7879ad"},(0,i.kt)("a",{parentName:"sup",href:"#fn-10-7879ad",className:"footnote-ref"},"10"))," flag causes Bazel to send extra headers in requests to the BES backend.\nIt behaves the same way as ",(0,i.kt)("a",{parentName:"p",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_header"},(0,i.kt)("inlineCode",{parentName:"a"},"--remote_header")),"."),(0,i.kt)("h2",{id:"thats-it-for-now"},"That's it, for now"),(0,i.kt)("p",null,"Hopefully with this information at hand,\nBazel's remote caching and remote execution capabilities are less of a mystery."),(0,i.kt)("div",{className:"footnotes"},(0,i.kt)("hr",{parentName:"div"}),(0,i.kt)("ol",{parentName:"div"},(0,i.kt)("li",{parentName:"ol",id:"fn-1-7879ad"},"Julio wrote a great ",(0,i.kt)("a",{parentName:"li",href:"https://jmmv.dev/2019/12/bazel-strategies.html"},"summary on spawn strategies")," that I highly recommend reading.",(0,i.kt)("a",{parentName:"li",href:"#fnref-1-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-2-7879ad"},"Except possibly if ",(0,i.kt)("a",{parentName:"li",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_accept_cached"},(0,i.kt)("inlineCode",{parentName:"a"},"--noremote_accept_cached"))," is set.\nSee the ",(0,i.kt)("a",{parentName:"li",href:"#flags"},"flags section"),".",(0,i.kt)("a",{parentName:"li",href:"#fnref-2-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-3-7879ad"},"Except if the action is tagged with ",(0,i.kt)("inlineCode",{parentName:"li"},"no-remote-cache-upload"),",\nor possibly if ",(0,i.kt)("a",{parentName:"li",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_upload_local_results"},(0,i.kt)("inlineCode",{parentName:"a"},"--noremote_upload_local_results"))," is set.\nSee the ",(0,i.kt)("a",{parentName:"li",href:"#flags"},"flags section"),".",(0,i.kt)("a",{parentName:"li",href:"#fnref-3-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-4-7879ad"},"Available in ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel/commit/7f08b7841fcf4c7d7d09b69f9ec1f24969aba8a1"},"Bazel 5.0"),".",(0,i.kt)("a",{parentName:"li",href:"#fnref-4-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-5-7879ad"},"Available in ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel/commit/46c3f1711b90c648baf3d15d6df2890c8a12f67c"},"Bazel 5.0"),".",(0,i.kt)("a",{parentName:"li",href:"#fnref-5-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-6-7879ad"},"Except if ",(0,i.kt)("a",{parentName:"li",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--remote_accept_cached"},(0,i.kt)("inlineCode",{parentName:"a"},"--noremote_accept_cached"))," is set.",(0,i.kt)("a",{parentName:"li",href:"#fnref-6-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-7-7879ad"},"If the ",(0,i.kt)("a",{parentName:"li",href:"https://docs.bazel.build/versions/5.0.0/command-line-reference.html#flag--experimental_remote_execution_keepalive"},(0,i.kt)("inlineCode",{parentName:"a"},"--experimental_remote_execution_keepalive"))," flag is set,\nthe ",(0,i.kt)("inlineCode",{parentName:"li"},"Execution.Execute")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"Execution.WaitExecute")," calls take into account the values of ",(0,i.kt)("inlineCode",{parentName:"li"},"--remote_timeout")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"--remote_retries"),",\nbut in a ",(0,i.kt)("a",{parentName:"li",href:"https://docs.google.com/document/d/1NgDPsCIwprDdqC1zj0qQrh5KGK2hQTSTux1DAvi4rSc"},"more complicated way"),".\nEven with that flag, the goal is for execution time to be unbounded,\nas it can vary greatly depending on the action being executed.",(0,i.kt)("a",{parentName:"li",href:"#fnref-7-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-8-7879ad"},"A warning though:\nsetting ",(0,i.kt)("inlineCode",{parentName:"li"},"--experimental_build_event_upload_strategy=local")," will prevent the uploading of some nice things,\nsuch as the timing profile,\nor test logs.",(0,i.kt)("a",{parentName:"li",href:"#fnref-8-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-9-7879ad"},"Available in ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel/commit/bfc24139d93f8643686d91596ba347df2e01966a"},"Bazel 5.0"),".",(0,i.kt)("a",{parentName:"li",href:"#fnref-9-7879ad",className:"footnote-backref"},"\u21a9")),(0,i.kt)("li",{parentName:"ol",id:"fn-10-7879ad"},"Available in ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/bazelbuild/bazel/commit/ef42d1365d0f508d3d817997b5049639a72100ab"},"Bazel 5.0"),".",(0,i.kt)("a",{parentName:"li",href:"#fnref-10-7879ad",className:"footnote-backref"},"\u21a9")))))}u.isMDXComponent=!0},58553:function(e,t,a){t.Z=a.p+"assets/images/action-graph-baae4ebd49d1df74b6f39951baa33250.svg"}}]);