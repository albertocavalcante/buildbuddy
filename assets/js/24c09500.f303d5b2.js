"use strict";(self.webpackChunkbuildbuddy_docs_website=self.webpackChunkbuildbuddy_docs_website||[]).push([[7460],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),u=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(l.Provider,{value:t},e.children)},p="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,i=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=u(n),m=o,h=p["".concat(l,".").concat(m)]||p[m]||d[m]||i;return n?a.createElement(h,r(r({ref:t},c),{},{components:n})):a.createElement(h,r({ref:t},c))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=n.length,r=new Array(i);r[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[p]="string"==typeof e?e:o,r[1]=s;for(var u=2;u<i;u++)r[u]=n[u];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},90650:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return l},default:function(){return h},frontMatter:function(){return s},metadata:function(){return u},toc:function(){return p}});var a=n(83117),o=n(80102),i=(n(67294),n(3905)),r=["components"],s={slug:"buck2-review",title:"Buck2 Unboxing",description:"A review of Meta's new build tool Buck2.",author:"Son Luong Ngoc",author_title:"Solution Engineer @ BuildBuddy",date:"2023-05-30:12:00:00",author_url:"https://github.com/sluongng/",author_image_url:"https://avatars.githubusercontent.com/u/26684313?v=4",image:"/img/blog/buck2-header.png",tags:["buck2","engineering"]},l="Buck2 unboxing",u={permalink:"/blog/buck2-review",editUrl:"https://github.com/buildbuddy-io/buildbuddy/edit/master/website/blog/buck2.md",source:"@site/blog/buck2.md",title:"Buck2 Unboxing",description:"A review of Meta's new build tool Buck2.",date:"2023-05-30T12:00:00.000Z",formattedDate:"May 30, 2023",tags:[{label:"buck2",permalink:"/blog/tags/buck-2"},{label:"engineering",permalink:"/blog/tags/engineering"}],readingTime:15.325,hasTruncateMarker:!0,authors:[{name:"Son Luong Ngoc",title:"Solution Engineer @ BuildBuddy",url:"https://github.com/sluongng/",imageURL:"https://avatars.githubusercontent.com/u/26684313?v=4"}],frontMatter:{slug:"buck2-review",title:"Buck2 Unboxing",description:"A review of Meta's new build tool Buck2.",author:"Son Luong Ngoc",author_title:"Solution Engineer @ BuildBuddy",date:"2023-05-30:12:00:00",author_url:"https://github.com/sluongng/",author_image_url:"https://avatars.githubusercontent.com/u/26684313?v=4",image:"/img/blog/buck2-header.png",tags:["buck2","engineering"]},prevItem:{title:"Providing Control Over Cache Encryption",permalink:"/blog/customer-managed-encryption-keys"},nextItem:{title:"Keyboard Shortcuts in BuildBuddy",permalink:"/blog/keyboard-shortcuts"}},c={authorsImageUrls:[void 0]},p=[{value:"Overview",id:"overview",level:2},{value:"The pros",id:"the-pros",level:2},{value:"Incredible CLI UX",id:"incredible-cli-ux",level:4},{value:"First-class Remote Execution",id:"first-class-remote-execution",level:4},{value:"Easy to contribute",id:"easy-to-contribute",level:4},{value:"The cons",id:"the-cons",level:2},{value:"It&#39;s actually multiple phases!",id:"its-actually-multiple-phases",level:4},{value:"No Build Telemetry",id:"no-build-telemetry",level:4},{value:"No Repository Phase",id:"no-repository-phase",level:4},{value:"Complicated testing abstraction",id:"complicated-testing-abstraction",level:4},{value:"Other foot guns",id:"other-foot-guns",level:4},{value:"The verdict",id:"the-verdict",level:2}],d={toc:p},m="wrapper";function h(e){var t=e.components,s=(0,o.Z)(e,r);return(0,i.kt)(m,(0,a.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Recently Meta announced the release of Buck2, their official build tool that was rewritten in Rust.\nI got a chance to try it and integrate it with BuildBuddy's Remote Cache and Remote Build Execution offerings."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(85095).Z,width:"800",height:"485"})),(0,i.kt)("p",null,"Here are the initial impressions I have after a week of using Buck2."),(0,i.kt)("h2",{id:"overview"},"Overview"),(0,i.kt)("p",null,"Similar to Buck(1) and Bazel, Buck2 is an ",(0,i.kt)("a",{parentName:"p",href:"https://bazel.build/basics/artifact-based-builds"},"artifact-based")," build tool that operates on a large graph of dependencies."),(0,i.kt)("p",null,"Buck2 was rewritten from scratch in Rust while providing many backward compatibility features with Buck(1).\nOn the ",(0,i.kt)("a",{parentName:"p",href:"https://buck2.build/docs/why/"},"official website of Buck2"),", Meta touted it to be:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Remote Execution first"),(0,i.kt)("li",{parentName:"ol"},"Dynamic graph computation engine"),(0,i.kt)("li",{parentName:"ol"},"A single build phase")),(0,i.kt)("p",null,"So how true are these claims?\nIs Buck2 going to replace Bazel?\nIs this the right tool for your needs?"),(0,i.kt)("p",null,"Let's dive in!"),(0,i.kt)("h2",{id:"the-pros"},"The pros"),(0,i.kt)("h4",{id:"incredible-cli-ux"},"Incredible CLI UX"),(0,i.kt)("p",null,"Right out of the box, Buck2 feels incredibly responsive.\nThe command line is ridiculously fast compared to Bazel 6.2.0.\nHere, we are using ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/sharkdp/hyperfine"},"Hyperfine")," to benchmark the two build tools."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> hyperfine 'buck2 --version' --shell=none --warmup 3 --runs 20\nBenchmark 1: buck2 --version\n  Time (mean \xb1 \u03c3):       5.5 ms \xb1   0.6 ms    [User: 2.7 ms, System: 1.4 ms]\n  Range (min \u2026 max):     5.0 ms \u2026   7.1 ms    20 runs\n\n> hyperfine 'bazel version' --shell=none --warmup 3 --runs 20\nBenchmark 1: bazel version\n  Time (mean \xb1 \u03c3):      31.2 ms \xb1   0.7 ms    [User: 9.7 ms, System: 11.8 ms]\n  Range (min \u2026 max):    29.8 ms \u2026  32.4 ms    20 runs\n")),(0,i.kt)("p",null,"Moreover, the CLI was written in Rust's Clap library, which comes with a sane help menu\nand (soon to come) auto-completion."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> buck2 -h\nbuck2 42652bf853883e0391382f6b8d038fe6 <local>\nA build system\n\nDocumentation: https://buck2.build/docs/\n\nUSAGE:\n    buck2 [OPTIONS] <SUBCOMMAND>\n\nOPTIONS:\n    -h, --help\n            Print help information\n\n        --isolation-dir <ISOLATION_DIR>\n            Instances of Buck2 share a daemon if and only if their isolation directory is identical.\n            The isolation directory also influences the output paths provided by Buck2, and as a\n            result using a non-default isolation dir will cause cache misses (and slower builds)\n            [env: BUCK_ISOLATION_DIR=] [default: v2]\n\n    -v, --verbose <NUMBER>\n            How verbose buck should be while logging. Values: 0 = Quiet, errors only; 1 = default; 2\n            = more info about errors; 3 = more info about everything [default: 1]\n\n    -V, --version\n            Print version information\n\nSUBCOMMANDS:\n    aquery       Perform queries on the action graph (experimental)\n    audit        Perform lower level queries\n    build        Build the specified targets\n    bxl          Run BXL scripts\n    clean        Delete generated files and caches\n    cquery       Perform queries on the configured target graph\n    ctargets     Resolve target patterns to configured targets\n    docs         Print documentation of specified symbols\n    help         Print this message or the help of the given subcommand(s)\n    init         Initialize a buck2 project\n    install      Build and install an application\n    kill         Kill the buck daemon\n    killall      Kill all buck2 processes on the machine\n    log          Commands for interacting with buck2 logs\n    lsp          Start an LSP server for starlark files\n    profile      Profiling mechanisms\n    query        Alias for `uquery`\n    rage         Record information about the previous failed buck2 command\n    root         Find buck cell, project or package root\n    run          Build and run the selected target\n    server       Start, query, and control the http server\n    starlark     Run Starlark operations\n    status       Buckd status\n    subscribe    Subscribe to updates from the Buck2 daemon\n    targets      Show details about the specified targets\n    test         Build and test the specified targets\n    uquery       Perform queries on the unconfigured target graph\n")),(0,i.kt)("p",null,"This means that even the subcommands flags are declared with the framework and\ncomes with amazing default documentation."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> buck2 rage -h\nbuck2-rage\nRecord information about the previous failed buck2 command\n\nUSAGE:\n    buck2 rage [OPTIONS]\n\nOPTIONS:\n    -h, --help\n            Print help information\n\n        --invocation-id <INVOCATION_ID>\n            Select invocation directly using the invocation's UUID\n\n        --invocation-offset <INVOCATION_OFFSET>\n            Use value 0 to select last invocation, 1 to select second to last and so on\n\n        --no-invocation\n            Collect rage report about buck2 in general, not about specific invocation\n\n        --no-paste\n            We may want to omit paste if this is not a user or is called in a machine with no pastry\n            command\n\n        --origin <ORIGIN>\n            Where buck2 rage is being called from [default: unspecified] [possible values:\n            hang-detector, unspecified]\n\n        --timeout <TIMEOUT>\n            Stop collecting information after `<timeout>` seconds [default: 60]\n\n    -v, --verbose <NUMBER>\n            How verbose buck should be while logging. Values: 0 = Quiet, errors only; 1 = default; 2\n            = more info about errors; 3 = more info about everything [default: 1]\n")),(0,i.kt)("p",null,"The build progress library was custom-made for Buck2 and can sort and color-code slower actions.\nHere is a quick sped up demo:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(68892).Z,width:"777",height:"250"})),(0,i.kt)("h4",{id:"first-class-remote-execution"},"First-class Remote Execution"),(0,i.kt)("p",null,'Buck2 was not kidding about it being a "Remote Execution first" build tool.'),(0,i.kt)("p",null,"Thanks to this assumption, Buck2 was able to cut corners by not providing any local-sandboxing implementations by default.\nWhat seems to be an unwanted side-effect at scale, actually made the tool more friendly to new learners.\nThe lack of local sandboxing allows Buck2 to behave locally closer to other task-runner build tools such as Make or Just."),(0,i.kt)("p",null,"However, any mistakes that are made when authoring build definitions locally will very soon be revealed once moved to Remote Build Execution.\nBuck2 follows the same industry standard ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/bazelbuild/remote-apis"},"Remote Execution API")," that was adopted by the like of Bazel, Goma, Pants, Please, Recc...\nThis means that Buck2 is compatible with BuildBuddy Remote Cache and Remote Build Execution offering! \ud83c\udf89"),(0,i.kt)("p",null,"So let's test it out!"),(0,i.kt)("p",null,"First, let's establish a setup to benchmark our test"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-python"},'SIZE_RANGE = range(0, 1000)\n\nXYZ_SHA256 = "72036ae48c55d632cc333cac04c78be336b0c76f39b225d023e218efe077ab1b"\n\n# Add some execution time to each action to simulate a real build.\nSLEEP_CMD = "sleep $$((RANDOM % 5));"\n\n# Stage 1\n[\n    genrule(\n        name = "x_{}".format(n),\n        outs = ["x_{}.txt".format(n)],\n        cmd = SLEEP_CMD + "echo x_{} > $@".format(n),\n    )\n    for n in SIZE_RANGE\n]\n\n[\n    genrule(\n        name = "y_{}".format(n),\n        outs = ["y_{}.txt".format(n)],\n        cmd = SLEEP_CMD + "echo y_{} > $@".format(n),\n    )\n    for n in SIZE_RANGE\n]\n\n# Stage 2\n[\n    genrule(\n        name = "z_{}".format(n),\n        outs = ["z_{}.txt".format(n)],\n        cmd = SLEEP_CMD + "cat $(location :x_{n}) $(location :y_{n}) > $@".format(n = n),\n        tools = [\n            ":x_{}".format(n),\n            ":y_{}".format(n),\n        ],\n    )\n    for n in SIZE_RANGE\n]\n\n# Stage 3\ngenrule(\n    name = "xyz",\n    outs = ["xyz.txt"],\n    # cat $(location :z_0) $(location :z_1) ... $(location :z_999) > $@,\n    cmd = SLEEP_CMD + "cat " + " ".join([\n        "$(location :z_{})".format(n)\n        for n in SIZE_RANGE\n    ]) + " > $@",\n    tools = [\n        ":z_{}".format(n)\n        for n in SIZE_RANGE\n    ],\n)\n\n# Stage 4\nsh_test(\n    name = "test",\n    srcs = ["test.sh"],\n    args = [\n        "$(location :xyz)",\n        XYZ_SHA256,\n    ],\n    data = [\n        ":xyz",\n    ],\n)\n')),(0,i.kt)("p",null,"Our setup is a build graph composed of 4 stages:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},'Stage 1: Create 1000 "x" targets and 1000 "y" targets (2000 build targets)')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},'Stage 2: Create 1000 "z" targets by concat "x" and "y" from Stage 1 (1000 build targets)')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},'Stage 3: Concat all "z" targets (1 build target)')),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Stage 4: Validate stage 3 output with a test (1 test target)"))),(0,i.kt)("p",null,"Before each action, we sleep a random duration between 0 and 4 seconds to make the simulation closer to real-world build."),(0,i.kt)("p",null,"We also inject this sleep value into our test to help validate testing features down the line:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> cat test.sh\n#!/bin/bash\n\nfile=$1\nexpected=$2\ngot=$(sha256sum $file | awk '{print $1}')\n\nsleep $((RANDOM % 5));\nif [[ $expected == $got ]]; then\n    exit 0\nelse\n    exit 1\nfi\n")),(0,i.kt)("p",null,"With a total of 2002 user-defined targets and 4 stages, assuming perfect concurrency,\nit should result in a worst-case 16 seconds, average 8 seconds, sleep overhead."),(0,i.kt)("p",null,"Let's use Bazel's latest release, 6.2.0, as our baseline and see how Buck2 compares."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Local Execution"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> cat .bazelrc\nbuild:local --strategy=local\nbuild:local --jobs=200\nbuild:local --local_cpu_resources=200\nbuild:local --local_ram_resources='HOST_RAM*2.0'\n")),(0,i.kt)("p",{parentName:"li"},"It's worth noting that Bazel executes actions in a sandbox by default, so ",(0,i.kt)("inlineCode",{parentName:"p"},"--strategy=local")," is used here to explicitly disable sandboxing.\nWe also set Bazel's concurrency limit to 200 by specifying ",(0,i.kt)("inlineCode",{parentName:"p"},"--jobs=200")," and override Bazel's system resource estimations by specifying\n",(0,i.kt)("inlineCode",{parentName:"p"},"--local_cpu_resources")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"--local_ram_resources")," to larger values.\nBecause our actions are lightweight, with majority of the time being spent on ",(0,i.kt)("inlineCode",{parentName:"p"},"sleep(1)"),' call,\nthese Bazel flags enable us to hit the "200 concurrent build actions" mark.'),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> hyperfine --prepare 'bazel clean' --warmup 1 'bazel test --config=local //...'\nBenchmark 1: bazel test --config=local //...\n  Time (mean \xb1 \u03c3):     65.631 s \xb1  0.460 s    [User: 0.051 s, System: 0.063 s]\n  Range (min \u2026 max):   65.179 s \u2026 66.310 s    10 runs\n")),(0,i.kt)("p",{parentName:"li"},"To ensure fairness, we also set Buck2 execution concurrency to the same value as Bazel:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> tail -2 .buckconfig\n[build]\nthreads = 200\n")),(0,i.kt)("p",{parentName:"li"},"Here, Buck's Starlark API differs slightly from Bazel's, so some small modifications were needed.\nFor example:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-diff"},'@@ -21,9 +21,9 @@\n [\n     genrule(\n         name = "z_{}".format(n),\n-        outs = ["z_{}.txt".format(n)],\n+        out = "z_{}.txt".format(n),\n-        cmd = "cat $(location :x_{n}) $(location :y_{n}) > $@".format(n = n),\n+        cmd = "cat $(location :x_{n}) $(location :y_{n}) >$OUT".format(n = n),\n-        tools = [\n+        srcs = [\n             ":x_{}".format(n),\n             ":y_{}".format(n),\n         ],\n')),(0,i.kt)("p",{parentName:"li"},"With all that set, let's see how Buck2 performs:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"> hyperfine  --prepare 'buck2 clean' --warmup 1 'buck2 test //...'\nBenchmark 1: buck2 test //...\n  Time (mean \xb1 \u03c3):     41.175 s \xb1  2.183 s    [User: 0.371 s, System: 0.190 s]\n  Range (min \u2026 max):   37.584 s \u2026 43.803 s    10 runs\n")),(0,i.kt)("p",{parentName:"li"},"And quite a performance indeed, Buck2 left Bazel in the dust!")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Remote Execution"),(0,i.kt)("p",{parentName:"li"},"Using BuildBuddy as the RBE backend should be as simple as copying the configurations from the website:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},"build:remote --jobs=600\n\nbuild:remote --bes_results_url=https://app.buildbuddy.io/invocation/\nbuild:remote --bes_backend=grpcs://remote.buildbuddy.io\nbuild:remote --remote_cache=grpcs://remote.buildbuddy.io\nbuild:remote --remote_timeout=3600\nbuild:remote --remote_executor=grpcs://remote.buildbuddy.io\nbuild:remote --remote_header=x-buildbuddy-api-key=<redacted>\n")),(0,i.kt)("p",{parentName:"li"},"With that set, let's check the result:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# With remote cache\n> hyperfine --prepare 'bazel clean' \\\n            --warmup 1 \\\n            'bazel test --config=remote //...'\nBenchmark 1: bazel test --config=remote //...\n  Time (mean \xb1 \u03c3):      9.798 s \xb1  0.515 s    [User: 0.028 s, System: 0.039 s]\n  Range (min \u2026 max):    8.645 s \u2026 10.434 s    10 runs\n\n# Without remote cache\n# Set remote_instance_name to a random string to reset remote_cache\n> hyperfine  --prepare 'bazel clean' \\\n             --warmup 1 \\\n             'bazel test --config=remote --remote_instance_name=\"$RANDOM\" //...'\nBenchmark 1: bazel test --config=remote --remote_instance_name=\"$RANDOM\" //...\n  Time (mean \xb1 \u03c3):     106.062 s \xb1  3.106 s    [User: 0.090 s, System: 0.099 s]\n  Range (min \u2026 max):   102.111 s \u2026 111.645 s    10 runs\n")),(0,i.kt)("p",{parentName:"li"},"17 seconds is amazing compared to the local execution time of 74 seconds.\nIt's 73% faster!"),(0,i.kt)("p",{parentName:"li"},"But what about Buck2?\nWell setting it up is as simple as copying the provided configurations in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/tree/main/examples/remote_execution/buildbuddy"},"Buck2's BuildBuddy Example")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[build]\nexecution_platforms = root//platforms:platforms\n\n# [buck2_re_client]\nengine_address = remote.buildbuddy.io\naction_cache_address = remote.buildbuddy.io\ncas_address = remote.buildbuddy.io\nhttp_headers = x-buildbuddy-api-key:<redacted>\n")),(0,i.kt)("p",{parentName:"li"},"Let's run it:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# With remote cache\n> hyperfine --prepare 'buck2 clean' \\\n            --warmup 1 \\\n            'buck2 test --unstable-allow-all-tests-on-re //...'\n  Time (mean \xb1 \u03c3):      7.937 s \xb1  0.487 s    [User: 0.296 s, System: 0.175 s]\n  Range (min \u2026 max):    7.357 s \u2026  8.945 s    10 runs\n\n# Without remote cache\n> hyperfine --prepare 'buck2 clean; echo \"INSTANCE_NAME = \\\"$RANDOM\\\"\" > instance.bzl' \\\n            'buck2 test --unstable-allow-all-tests-on-re //...'\nBenchmark 1: buck2 test --unstable-allow-all-tests-on-re //...\n  Time (mean \xb1 \u03c3):     203.431 s \xb1 29.882 s    [User: 4.187 s, System: 1.566 s]\n  Range (min \u2026 max):   163.044 s \u2026 258.968 s    10 runs\n")),(0,i.kt)("p",{parentName:"li"},"Buck2 does not have a good way to invalidate the remote cache to give a fair comparison,\nso I did apply a workaround by invalidating all the ",(0,i.kt)("inlineCode",{parentName:"p"},"x")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"y")," actions with a random value instead."),(0,i.kt)("p",{parentName:"li"},"Regardless, the performance was very impressive.\nThe Remote Build Execution client of Buck2 is not as configurable as Bazel, so it was harder to tune.\nI expect it will make builds perform much better in the future."))),(0,i.kt)("h4",{id:"easy-to-contribute"},"Easy to contribute"),(0,i.kt)("p",null,"Seriously, Buck2 code base is a blast to work with.\nUnlike Bazel, which was written in a mix of C++ and Java using Google's homegrown frameworks,\nBuck2 was built with a single language: Rust!"),(0,i.kt)("p",null,'Not only can the code base be built using Buck2, but it could also be built using Cargo, and\nis completely compatible with Rust Analyzer (Rust\'s Language Server).\nIt has been a long time since I could open the code base of a build tool and have "Go to definitions"\nand "Find references" work out of the box.'),(0,i.kt)("p",null,"The Buck2 team in Meta has been quite engaging thus far.\nIt often takes them less than a week to respond to my GitHub Issues / Pull Requests.\nAnd most of the time, I get a response within a day."),(0,i.kt)("p",null,"Diving into Buck2 and its Rust code base is... addictive. \ud83d\ude05"),(0,i.kt)("h2",{id:"the-cons"},"The cons"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"So is that it? Buck2 is faster, let's all move there?")),(0,i.kt)("p",null,"Not so fast young padawan!\nBuck2 does come with some downsides."),(0,i.kt)("h4",{id:"its-actually-multiple-phases"},"It's actually multiple phases!"),(0,i.kt)("p",null,"In contrary to it's official introduction, ",(0,i.kt)("a",{parentName:"p",href:"https://buck2.build/docs/developers/architecture/buck2/"},"Buck2's architecture diagram"),"\ndescribes multiple phases and stages inside a typical build."),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(22870).Z,width:"2060",height:"1256"})),(0,i.kt)("p",null,"There seems to be 5 Phases acting as transitions between 5 states of Buck2 dynamic build graph, ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/tree/main/dice"},"DICE"),"."),(0,i.kt)("p",null,'The good thing about Buck2 is that none of these phases are "blocking", and thus multiple targets could\ntransition through different states in great parallelization. Bazel is also trying to work toward this\nsetup with the recently announced ',(0,i.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=IEJLHNNRP9U&list=PLxNYxgaZ8RsdH4GCIZ69dzxQCOPyuNlpF&index=10"},"SkyMeld project"),"."),(0,i.kt)("h4",{id:"no-build-telemetry"},"No Build Telemetry"),(0,i.kt)("p",null,"First of all, because Buck2 does not implement Bazel's Build Event Stream protocol (not part of Remote Execution API),\nwe are not able to integrate with it to display your test results and provide you with sweet cache hit/miss analysis as we have with Bazel."),(0,i.kt)("p",null,"Buck2 does come with a proto-defined set of ",(0,i.kt)("inlineCode",{parentName:"p"},"BuckEvent")," data.\nCurrently, these log-like data are stored locally under ",(0,i.kt)("inlineCode",{parentName:"p"},"buck-out/log")," and could be interacted with using troubleshooting commands such as ",(0,i.kt)("inlineCode",{parentName:"p"},"buck2 what-failed"),"."),(0,i.kt)("p",null,"Internally in Meta, these log data are sent to their ",(0,i.kt)("a",{parentName:"p",href:"https://engineering.fb.com/2019/10/07/data-infrastructure/scribe/"},"message queue system Scribe")," using Thrift RPC, which is consumed by their Telemetry Data platform ",(0,i.kt)("a",{parentName:"p",href:"https://research.facebook.com/publications/scuba-diving-into-data-at-facebook/"},"Scuba"),".\nHowever, there is no open-source implementation equivalent and I created ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/226"},"buck2/issue/226")," to discuss the creation of one."),(0,i.kt)("h4",{id:"no-repository-phase"},"No Repository Phase"),(0,i.kt)("p",null,'In Bazel, external dependencies to the build are prepared before build execution happens, in the "Repository Phase".'),(0,i.kt)("p",null,"Buck2 is touted to be a single phases build tool, so how does it manage 3rd party dependencies then?\nCurrently, there are only a limited set of options:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Git submodules\nBuck2 comes with ",(0,i.kt)("strong",{parentName:"p"},"Prelude"),", an open-source git repository that is meant to help define most Buck2 build rules.\nHowever, for each new Buck2 project being created with ",(0,i.kt)("inlineCode",{parentName:"p"},"buck2 init"),", you would need to set up Prelude as a git submodule in your git repo.\nWithout prelude, you would not get access to even basic rules such as ",(0,i.kt)("inlineCode",{parentName:"p"},"genrule")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"sh_binary"),".")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Vendor\nSince the majority of Buck2 is written in Rust, the companion tool ",(0,i.kt)("strong",{parentName:"p"},"Reindeer")," helps you vendor all\nCargo external packages into the repository and set up appropriate ",(0,i.kt)("inlineCode",{parentName:"p"},"BUCK")," files for them.\nThis is not a problem for Meta internally, with their custom monorepo and virtual file system ",(0,i.kt)("a",{parentName:"p",href:"https://sapling-scm.com/"},"Sapling"),",\nbut it should be a huge problem for Git repos and code review systems in the open-source world.")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Anon target and dynamic outputs\nAlthough there is no repository phase, you could still define ",(0,i.kt)("inlineCode",{parentName:"p"},"http_archive")," to have external downloads happen during Buck2 build execution.\nHowever, you will not be able to export build targets out of these newly downloaded archives easily.\nInstead of the Bazel approach which lets you run some commands to generate ",(0,i.kt)("inlineCode",{parentName:"p"},"BUILD")," files,\nBuck2 provides the complicated anon target, sub-targets, and dynamic outputs APIs in Starlark for you to accomplish the same thing.\nHowever, there is very limited documentation and examples of how these APIs work."))),(0,i.kt)("h4",{id:"complicated-testing-abstraction"},"Complicated testing abstraction"),(0,i.kt)("p",null,"Unlike Bazel, which treats tests as another build action to be executed at the end of the graph,\nBuck2 took this to a whole new level by introducing a new RPC to integrate Buck2 with their internal testing platform ",(0,i.kt)("a",{parentName:"p",href:"https://buck2.build/docs/rule_authors/test_execution/"},"TPX"),"."),(0,i.kt)("p",null,"Because TPX is in charge of coordinating test executions on various platforms and collecting related test outputs data,\nthe set of APIs that define integration between Buck2 and TPX is also quite featureful.\nHowever, there is not a lot of documentation at this moment regarding how these work."),(0,i.kt)("p",null,"Because of this reason, there is no test caching in Buck2 by default as the test target selector is supposed to be handled. But there are ongoing conversation about this in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/183"},"buck2/issue/183"),"."),(0,i.kt)("h4",{id:"other-foot-guns"},"Other foot guns"),(0,i.kt)("p",null,"There are several pain points I experienced while testing out Buck2. They range from small annoyances to rendering the tool completely un-usable \ud83d\ude13:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"p"},"http_archive")," does not work from within anon target. Fixed in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2-prelude/commit/370cd4d8b2cd002e0f794b91520febcab289b7d0"},"buck2/commit/370cd4d"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"All Go rules are not usable without a standard library to compile/link against. Reported in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/240"},"buck2/issue/240"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Lack of documentation for ",(0,i.kt)("inlineCode",{parentName:"p"},".buckconfig")," keys and default values. Reported in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/152"},"buck2/issue/152"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"No local cache for external downloads (leading to re-download happening on a Buck Daemon reset). Reported in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/246"},"buck2/issue/246"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Terminal UI reported the wrong value for actions counts. Reported in ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/251"},"buck2/issue/251"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Remote Execution does not have symlinks support ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/222"},"buck2/issue/222"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Simply crash and not usable ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/issues/257"},"buck2/issue/257"),", but fixed with ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/facebook/buck2/commit/79471567dd5e05f4035515c697e3fb9ef78622ac"},"buck2/commit/7947156"),"."))),(0,i.kt)("h2",{id:"the-verdict"},"The verdict"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"So what does all this mean?"),(0,i.kt)("p",{parentName:"blockquote"},"Should I start using Buck2 today?")),(0,i.kt)("p",null,"Buck2 is a fresh, new shiny build tool on the block.\nWith it comes a lot of good things:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Great language, great performance")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Fresh UI")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Compatibility with existing RBE services"))),(0,i.kt)("p",null,"It has all the joy and excitement of a typical green field project that attracts the Rust (and potentially C++) community toward it."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"But is it a Bazel replacement?"),(0,i.kt)("p",{parentName:"blockquote"},"Should an enterprise consider adopting this for hundreds to thousands of users?")),(0,i.kt)("p",null,"I would say ",(0,i.kt)("em",{parentName:"p"},"not yet"),"!"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"There are still too many foot guns that come with the new tool (as documented above).")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"There is not enough configurations and/or documentation to support large-scale enterprise users.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Users are expected to be hands-on with the code base. If you don't know Rust... well you better learn it first.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Lack of build rules and toolings for typical use cases: building a container image, a typescript project, a go binary... are not possible just yet."))),(0,i.kt)("p",null,"My conclusion is that Buck2 is exciting!\nHowever, today, it's still young and too early to replace typical enterprise use cases.\nI hope the current excitement could grow a community and ecosystem around Buck2 sustainably to further drive the tool to maturity."),(0,i.kt)("p",null,"In the meantime, I have created a repository to collect ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/sluongng/awesome-buck2"},"all Buck2-related resources here"),".\nIf you are interested in Buck2, give it a look!"))}h.isMDXComponent=!0},68892:function(e,t,n){t.Z=n.p+"assets/images/buck2-success-d388fa5c0141b3aa94952bbb94f8732c.gif"},85095:function(e,t,n){t.Z=n.p+"assets/images/buck2-780fab897c58d52a2c5e43171a00a001.jpg"},22870:function(e,t,n){t.Z=n.p+"assets/images/buck2_architecture-2404c487eb4c04045a09b9c7e27dd867.png"}}]);