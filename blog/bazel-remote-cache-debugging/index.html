<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="BuildBuddy RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="BuildBuddy Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-156160991-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">Bazel Remote Cache Debugging | BuildBuddy</title><meta data-react-helmet="true" property="og:title" content="Bazel Remote Cache Debugging | BuildBuddy"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:description" content="All about the new cache requests card and how to use it."><meta data-react-helmet="true" property="og:url" content="https://www.buildbuddy.io/blog/bazel-remote-cache-debugging"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="description" content="BuildBuddy provides enterprise features for Bazel — the open source build system that allows you to build and test software 10x faster."><meta data-react-helmet="true" name="og:description" content="BuildBuddy provides enterprise features for Bazel — the open source build system that allows you to build and test software 10x faster."><meta data-react-helmet="true" property="og:image" content="https://www.buildbuddy.io/img/blog/remote-cache-debugging.png"><meta data-react-helmet="true" name="twitter:image" content="https://www.buildbuddy.io/img/blog/remote-cache-debugging.png"><link data-react-helmet="true" rel="icon" href="/img/favicon_black.svg"><link data-react-helmet="true" rel="canonical" href="https://www.buildbuddy.io/blog/bazel-remote-cache-debugging"><link data-react-helmet="true" rel="alternate" href="https://www.buildbuddy.io/blog/bazel-remote-cache-debugging" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.buildbuddy.io/blog/bazel-remote-cache-debugging" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.e09f6429.css">
<link rel="preload" href="/assets/js/runtime~main.27de821d.js" as="script">
<link rel="preload" href="/assets/js/main.1eee4f2b.js" as="script">
</head>
<body data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="BuildBuddy Logo" class="themedImage_1VuW themedImage--light_3UqQ" height="32px" width="191px"><img src="/img/logo_white.svg" alt="BuildBuddy Logo" class="themedImage_1VuW themedImage--dark_hz6m" height="32px" width="191px"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" href="/features">Features</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/ui">Build &amp; Test UI</a></li><li><a class="dropdown__link" href="/remote-execution">Remote Execution</a></li><li><a class="dropdown__link" href="/remote-cache">Remote Cache</a></li><li><a class="dropdown__link" href="/workflows">Workflows</a></li><li><a class="dropdown__link" href="/cli">BuildBuddy CLI</a></li><li><a class="dropdown__link" href="/plugins">Plugin Library</a></li></ul></div><a class="navbar__item navbar__link" target="_self" href="/pricing">Pricing</a><a href="https://github.com/buildbuddy-io/buildbuddy" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a class="navbar__item navbar__link" href="/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/docs/introduction/">Docs</a><a href="https://app.buildbuddy.io/" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://app.buildbuddy.io/" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link sign-up"><span>Get Started<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--1"></div><main class="col col--8"><article><header><h1 class="margin-bottom--sm blogPostTitle_3kJS">Bazel Remote Cache Debugging</h1><div class="margin-vert--md"><div class="heading_1SDJ"><div class="headingPhoto_1iKi"><a href="https://github.com/bduffany" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo undefined"><img src="https://avatars.githubusercontent.com/u/2414826?v=4" alt="Brandon Duffany"></a></div><div><span><a href="https://github.com/bduffany" target="_blank" rel="noopener noreferrer" class="authorName_3Kcr">Brandon Duffany</a>, <span>Engineer @ BuildBuddy</span></span><time datetime="2022-06-07T12:00:00.000Z" class="blogPostDate_247f"><br>June 7, 2022<!-- --> <!-- --> · <!-- -->5 min read</time></div></div></div></header><div class="markdown"><p>Using a remote cache is a great way to speed up your Bazel builds! But by
default, Bazel uploads almost everything to the remote cache.</p><p>If your network is slow and your build artifacts are very large (like a
docker image) this can lead to poor performance.</p><p>To address this, and make it easier to fix, we built the new cache
requests card.</p><p>In this post we&#x27;ll explore what insights this card can give you into your
builds, as well as some fun details about how the card works under the
hood.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="new-insights">New insights<a class="hash-link" href="#new-insights" title="Direct link to heading">​</a></h2><p>The cache requests card lets you answer some interesting questions about
your build which were not easily answerable before. Here are a few:</p><p><em><strong>My build seems to have uploaded a lot of data <!-- -->—<!-- --> which targets
uploaded the largest artifacts?</strong></em></p><p>To answer this question, select &quot;Sort by <strong>Size</strong>&quot; and &quot;Show <strong>All</strong>&quot;.
Then, select &quot;Group by <strong>None</strong>&quot;. This will show the largest artifacts
first, with target names displayed in the leftmost column.</p><p><img src="/assets/images/cache-requests-card-135fa673793b16090aafac8f4ded32cc.png"></p><p>We can see in this screenshot that the largest cache transfer was a
download of an artifact from the external repository
<code>com_github_tuist_xcodeproj</code>. To see the full target and action name,
hover over the row.</p><p><em><strong>I see some file references in the build event stream which aren&#x27;t
associated with an action. What are these files?</strong></em></p><p>To answer this question, select &quot;Show <strong>All</strong>&quot; and search for
<strong>bes-upload</strong>. You&#x27;ll see all the files which were uploaded by Bazel
and not associated with an action, including the timing profile.</p><p><img src="/assets/images/cache-requests-card-bes-upload-7e293efaf52bed7ebcb56232c8d5b0ba.png"></p><p>The build in this screenshot shows that a large artifact (285.9 MB) was
uploaded at the very end of the build, so it most likely was blocking the
build&#x27;s completion. We can see the full artifact path by hovering over the
row.</p><p><em><strong>I expected my build to be fully-cached, but it was not. Was there a
single action whose inputs or environment variables changed unexpectedly,
thus triggering all its dependent targets to be rebuilt?</strong></em></p><p>To answer this question, make sure you are sorted by <strong>start time</strong> in
ascending order, and take a look at the actions with the earliest
timestamps. The earliest action is most likely the root cause of the
change from the previous build.</p><p><img src="/assets/images/cache-requests-card-incremental-rebuild-c02480aa14d8761c7a51df2ca2c2257a.png"></p><p>Before the build in this screenshot, a file in the
<code>priority_task_scheduler</code> target was edited, which we can see triggered a
cascade of action executions that transitively depended on
<code>priority_task_scheduler</code>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="how-it-works">How it works<a class="hash-link" href="#how-it-works" title="Direct link to heading">​</a></h2><p>Implementing the cache requests card required solving a few interesting
problems.</p><p>The total size of the request metadata stored for each build is not
extremely large <!-- -->—<!-- --> just tens of megabytes for builds with hundreds of
thousands of cache requests <!-- -->—<!-- --> but we serve a high volume of
requests, and we don&#x27;t want to negatively impact cache performance just to
store this metadata for each request.</p><p>The simplest solution to implement would be to do a blocking write to a
MySQL table for each cache request. This would also be pretty convenient
for querying the data however we like. However, this would place far too
much load on the database and add way too much latency to each cache
request.</p><p>So, instead of using MySQL, we used Redis as an intermediate storage
medium while the invocation is in progress. Redis can handle a much higher
volume of writes than MySQL because it only stores values in memory and it
has a much simpler key-value storage model.</p><p>We can&#x27;t just store this data in Redis and call it a day, though. Firstly,
Redis does not give us long-term persistence, and it would be nice to be
able to keep this data around even for older invocations. To get long-term
persistence, we read all of the data from Redis and then serialize it into
a <a href="https://developers.google.com/protocol-buffers" target="_blank" rel="noopener noreferrer">proto</a>. We store this
proto into a &quot;blobstore,&quot; which is just a generic storage interface backed
by a local disk, Google Cloud Storage, Amazon S3, etc.</p><p>Secondly, even with the amazing performance of Redis, we can&#x27;t just issue
a single write request for every cache request. Doing a separate Redis
write for every request places a large amount of CPU load on Redis, since
it needs to do a <code>read()</code> and <code>write()</code> system call for each write.
(We learned this the hard way.)</p><p>To address this, we used Redis
<a href="https://redis.io/docs/manual/pipelining/" target="_blank" rel="noopener noreferrer"><strong>pipelining</strong></a>. Instead of
issuing Redis commands directly, we add each command to a pipeline, and
have a separate background job that periodically flushes the pipeline.
Adding the command to the pipeline is just a matter of appending to an
in-memory buffer, which takes just nanoseconds, so it doesn&#x27;t impact cache
performance to a significant degree.</p><p><img src="/assets/images/cache-requests-design-1-bb9607923185df1a8ec1ac72b31f8c1a.png"></p><p>Once an invocation is complete, we kick off a job to read all of the
requests from Redis and then store it as a single blob in blobstore.</p><p><img src="/assets/images/cache-requests-design-2-0ffff643976481b7c66e88f3caa70c4f.png"></p><p>To read back this data for the UI, all we have to do is load this whole
blob into memory and then apply any client-side sorting and filtering.
These blobs are small enough that we easily load the full blob into memory
on the server <!-- -->—<!-- --> the blob is too big to be loaded in a browser,
though, so we do use a relatively small page size.</p><p><img src="/assets/images/cache-requests-design-3-b2207697c8c431ab47b9653255dd12ed.png"></p><h2 class="anchor anchorWithStickyNavbar_31ik" id="whats-next">What&#x27;s next<a class="hash-link" href="#whats-next" title="Direct link to heading">​</a></h2><p>We hope that you find the new cache requests card useful and that you
enjoyed reading about how it works! We would love to hear your feedback,
which will help inform how we design the next iteration of our cache
debugging tools to help make your builds even faster and more scalable.
Join our <a href="https://slack.buildbuddy.io" target="_blank" rel="noopener noreferrer">Slack channel</a> or email us at
<a href="mailto:hello@buildbuddy.io" target="_blank" rel="noopener noreferrer">hello@buildbuddy.io</a> with any questions, comments, or thoughts.</p></div><footer class="row margin-vert--lg"><div class="tags_2aeM"><strong>Tags:</strong><a class="tag_3Sf8" href="/blog/tags/product">product</a><a class="tag_3Sf8" href="/blog/tags/engineering">engineering</a></div></footer></article><div><a href="https://github.com/buildbuddy-io/buildbuddy/edit/master/website/blog/bazel-remote-cache-debugging.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/welcoming-maggie-lou"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->Welcoming Maggie Lou</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/distributed-scheduling-for-faster-builds"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Distributed Scheduling for Faster Builds<!-- --> »</div></a></div></nav></div></main><div class="col col--3"><div class="blog-sidebar"><div class="sidebar_2tcx thin-scrollbar"><h3 class="sidebarItemTitle_1XYP">Recent posts</h3><ul class="sidebarItemList_3OT0"><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/welcoming-son-luong-ngoc">Welcoming Son Luong Ngoc</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/whats-new-in-bazel-6-0">What&#x27;s New in Bazel 6.0</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/welcoming-jim-hollenbach">Welcoming Jim Hollenbach</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/bazelcon">Bazelcon 2022 Recap</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/clickhouse-build-trends">How We Use ClickHouse to Analyze Trends Across Millions of Builds</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/welcoming-iain-macdonald">Welcoming Iain Macdonald</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/welcoming-maggie-lou">Welcoming Maggie Lou</a></li><li class="sidebarItem_ic0g"><a aria-current="page" class="sidebarItemLink_3PPN sidebarItemLinkActive_23br" href="/blog/bazel-remote-cache-debugging">Bazel Remote Cache Debugging</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/distributed-scheduling-for-faster-builds">Distributed Scheduling for Faster Builds</a></li><li class="sidebarItem_ic0g"><a class="sidebarItemLink_3PPN" href="/blog/meet-rules_xcodeproj">Meet rules_xcodeproj</a></li></ul></div></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items"><li class="footer__item"><a href="/"><img alt="BuildBuddy Logo" src="/img/logo_white.svg" width="281px" height="32px" class="footer-logo"></a></li></ul></div><div class="col footer__col"><div class="footer__title">Product</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/ui">Build &amp; Test UI</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/remote-execution">Remote Execution</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/remote-cache">Remote Cache</a></li><li class="footer__item"><a href="https://app.buildbuddy.io" target="_self" rel="noopener noreferrer" class="footer__link-item"><span>Get Started<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/docs/introduction/">Documentation</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/pricing">Pricing</a></li><li class="footer__item"><a href="https://app.buildbuddy.io/" target="_self" rel="noopener noreferrer" class="footer__link-item"><span>Login<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/privacy">Privacy Policy</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/terms">Terms of Service</a></li></ul></div><div class="col footer__col"><div class="footer__title">Company</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/buildbuddy-io/buildbuddy/issues/new" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Report an Issue<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/contact">Contact Us</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/team">Team</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/careers">Careers</a></li></ul></div><div class="col footer__col"><div class="footer__title">Security</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_self" href="/security">Security Overview</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/security-updates">Security Updates</a></li><li class="footer__item"><a class="footer__link-item" target="_self" href="/security-vulnerability-report">Report a Vulnerability</a></li></ul></div><div class="col footer__col"><div class="footer__title">Connect</div><ul class="footer__items"><li class="footer__item"><a href="http://slack.buildbuddy.io/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/buildbuddy_io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://linkedin.com/company/buildbuddy" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/buildbuddy-io" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2023 Iteration, Inc.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.27de821d.js"></script>
<script src="/assets/js/main.1eee4f2b.js"></script>
</body>
</html>